<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cali-Biotech: Production Command</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CDL3F645R2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CDL3F645R2');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * {
    box-sizing: border-box; /* Makes padding not break width */
}

html, body {
    width: 100%;
    margin: 0;
    padding: 0;
    overflow-x: hidden; /* Stops the horizontal "sliding" bug */
}

.container {
    width: 95% !important; /* Forces the main box to fit phones */
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px;
}
    :root { --primary: #4c6fff; --potential: #00ffcc; --bg: #0b0b12; --card: #161621; --border: #2a2a3a; --danger: #ff4c4c; --text: #e0e0e0; }
    
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display:flex; flex-direction:column; align-items:center; padding:10px; margin:0; }
    
    .container { background:var(--card); padding:20px; border-radius:24px; width:100%; max-width:1300px; box-shadow:0 30px 60px rgba(0,0,0,0.8); border: 1px solid var(--border); box-sizing: border-box; transition: 0.3s; }
    
    .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
    
    .card { background: #1f1f2e; padding: 18px; border-radius: 16px; border: 1px solid #333; }
    .card h3 { margin-top: 0; color: var(--primary); font-size: 0.75em; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 5px; }
    
    label { display:block; margin-top:8px; font-size: 0.65em; color: #888; text-transform: uppercase; font-weight: bold;}
    input, select { width:100%; padding:10px; margin-top:4px; border-radius:8px; border:1px solid #333; background:var(--bg); color:white; font-size: 0.85em; box-sizing: border-box; transition: 0.3s; }
    
    .inline-quad { display: grid; grid-template-columns: 1.2fr 0.8fr 0.8fr 1fr; gap: 5px; } 
 .dashboard-row {
        display: grid;
grid-template-columns: 1fr 1fr;
        gap: 20px;
 margin-top: 30px;
}
#auditWrapper { 
    grid-column: 1 / -1; 
}
    
    .analysis-panel { background:#1f1f2e; padding:20px; border-radius:20px; border: 1px solid #333; min-height: 450px; overflow-y: auto; position: relative;}
    
    .prepare-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(22, 22, 33, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; border-radius: 20px; text-align: center; padding: 20px; box-sizing: border-box; }
    .btn-prepare { background: transparent; color: var(--potential); border: 2px solid var(--potential); padding: 15px 30px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 0.8em; letter-spacing: 2px; transition: 0.3s; }
    .btn-prepare:hover { background: var(--potential); color: black; box-shadow: 0 0 20px rgba(0, 255, 204, 0.4); }

    .skill-bar-container { margin-bottom: 12px; transition: 0.3s opacity; }
    .skill-label { display: flex; justify-content: space-between; font-size: 0.75em; margin-bottom: 4px; font-weight: bold; }
    .bar-bg { background: #0b0b12; height: 8px; border-radius: 4px; overflow: hidden; border: 1px solid #333; }
    .bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--potential)); transition: width 0.5s ease; }
    .rec-exercise { font-size: 0.6em; color: var(--potential); margin-top: 3px; display: block; font-style: italic; opacity: 0.8; }
    
    .insight-block { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #2a2a3a; }
    .insight-title { font-weight: bold; color: var(--potential); font-size: 0.85em; display: block; margin-bottom: 4px; }
    .col-header { font-size: 0.5em; color: var(--primary); text-align: center; }

    .sim-active input, .sim-active select { border-color: var(--potential) !important; box-shadow: 0 0 10px rgba(0, 255, 204, 0.1); }
    .sim-toggle-container { text-align: center; margin-bottom: 20px; padding: 10px; border-radius: 50px; background: rgba(0, 255, 204, 0.05); display: inline-block; border: 1px solid rgba(0, 255, 204, 0.1); }

    .blog-section { width: 100%; max-width: 1300px; margin-top: 40px; padding: 20px; box-sizing: border-box; border-top: 1px solid var(--border); text-align: left; }
    .blog-link { color: var(--potential); text-decoration: none; font-size: 0.8em; margin-right: 20px; transition: 0.3s; }
    .blog-link:hover { color: white; text-decoration: underline; }

    table { width: 100%; font-size: 0.75em; border-collapse: collapse; margin-top: 10px; color: #bbb; }
    th { color: var(--primary); text-align: left; padding: 10px; border-bottom: 1px solid #333; text-transform: uppercase; font-size: 0.7em; }
    td { padding: 10px; border-bottom: 1px solid #222; }
    .btn-log { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.7em; transition: 0.3s; }
    .btn-log:hover { filter: brightness(1.2); box-shadow: 0 0 10px var(--primary); }

    /* HEATMAP STYLES */
    .heatmap-container { background: #1f1f2e; padding: 15px; border-radius: 20px; border: 1px solid #333; text-align: center; margin-top: 20px; }
    .joint { transition: fill 0.4s ease; fill: #444; }

    /* VOLUME OPTIMIZER STYLES */
    .volume-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
    .stat-box { background: #0b0b12; padding: 10px; border-radius: 12px; border: 1px solid #333; text-align: center; }
    .stat-val { display: block; font-size: 1.1em; font-weight: bold; color: var(--potential); }
    .stat-label { font-size: 0.55em; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .battery-bar { width: 100%; height: 8px; background: #333; border-radius: 4px; margin-top: 8px; overflow: hidden; }
    .battery-fill { height: 100%; background: var(--potential); transition: width 0.5s; width: 0%; }

    @media (max-width: 1000px) {
        .dashboard-row { grid-template-columns: 1fr; }
        .main-grid { grid-template-columns: 1fr; }
        .container { border-radius: 0; }
        h1 { font-size: 1.1em !important; }
        .blog-link { display: block; margin-bottom: 10px; }
        .analysis-panel { min-height: auto; }
        #chart-card { order: -1; width: 100%; }
    }
    @media (max-width: 600px) {
    /* Forces tables to be scrollable so they don't stretch the page */
    .matrix-wrapper, table {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Makes inputs easier to tap with thumbs */
    input, select, button {
        font-size: 16px !important; /* Prevents iPhone "Auto-Zoom" on focus */
        padding: 12px !important;
    }

    /* Stack your "Structure & Readiness" inputs vertically */
    .input-group {
        display: flex;
        flex-direction: column;
    }
}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1230203526545088"
     crossorigin="anonymous"></script>
</head>
<body onload="loadSavedData(); renderLogs();"> 
<div class="container" id="mainContainer">
    <nav style="padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: center; margin-bottom: 20px;">
    <a href="index.html" style="color: var(--primary); text-decoration: none; font-weight: bold; font-size: 0.8em; letter-spacing: 2px;">HOME</a>
</nav>
    <h1 style="text-align:center; color:var(--primary); font-size:1.4em; letter-spacing:4px; margin-bottom: 20px;">CALI-BIOTECH COMMAND</h1>

    <div style="text-align: center; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px;">
        <select id="unitSystem" onchange="updateLabels(); analyze(); saveToLocal();" style="width: 220px; background: #1f1f2e; color: var(--primary); border: 1px solid var(--primary);">
            <option value="met">METRIC (KG / CM)</option>
            <option value="imp">IMPERIAL (LBS / FT-IN)</option>
        </select>

        <div class="sim-toggle-container">
            <label style="cursor:pointer; display: flex; align-items: center; gap: 10px; padding: 0 15px;">
                <input type="checkbox" id="simMode" onchange="toggleSimMode()" style="width: auto; margin: 0;">
                <span style="color:var(--potential); font-size: 0.7em; letter-spacing: 2px; font-weight: bold;">ACTIVATE BIOTEST SIMULATION</span>
            </label>
        </div>
    </div>

    <div class="main-grid">
        <div class="card">
            <h3>Structure & Readiness</h3>
            <div class="inline-quad" style="grid-template-columns: 1fr 1fr;">
                <div><label id="wLabel">Weight (kg)</label><input type="number" id="weight" value="75" oninput="analyze();"></div>
                <div id="hMetric"><label>Height (cm)</label><input type="number" id="hCm" value="175" oninput="analyze();"></div>
                <div id="hImperial" style="display:none;"><label>Height (ft/in)</label>
                    <div style="display:flex; gap:5px;"><input type="number" id="hFt" value="5" oninput="analyze();"><input type="number" id="hIn" value="9" oninput="analyze();"></div>
                </div>
            </div>
            <label>Surface Stability</label>
            <select id="surface" onchange="analyze();"><option value="1.0">Stable (Floor)</option><option value="1.25">Unstable (Rings)</option></select>
            <label>CNS Readiness</label>
            <input type="range" id="cns" min="1" max="10" value="9" oninput="analyze();">
        </div>

        <div class="card">
            <h3>BW Basics & Skills</h3>
            <div class="inline-quad" style="grid-template-columns: 1fr 1fr;">
                <div><label>Max Pullups</label><input type="number" id="pullups" value="15" oninput="analyze();"></div>
                <div><label>Max Pushups</label><input type="number" id="pushups" value="35" oninput="analyze();"></div>
            </div>
            <div class="inline-quad" style="grid-template-columns: 1fr 1fr;">
                <div><label>Muscle-Ups</label><input type="number" id="mu" value="5" oninput="analyze();"></div>
                <div><label>Dead Hang (s)</label><input type="number" id="hang" value="60" oninput="analyze();"></div>
            </div>
            <div class="inline-quad" style="grid-template-columns: 1.2fr 0.8fr;">
                <div><label>Leg Inertia</label><select id="legRatio" onchange="analyze();"><option value="0.95">Short</option><option value="1.0" selected>Neutral</option><option value="1.1">Long/Heavy</option></select></div>
                <div><label>Form</label><select id="form" onchange="analyze();"><option value="1.0">Elite</option><option value="0.7">Piked</option></select></div>
            </div>
        </div>

        <div class="card">
            <h3>Weighted Matrix</h3>
            <div class="inline-quad"><div class="col-header">Weight</div><div class="col-header">Reps</div><div class="col-header">Sets</div><div class="col-header">RPE</div></div>
            <label id="pullLabel">Weighted Pull-up</label>
            <div class="inline-quad"><input type="number" id="wpW" value="25" oninput="analyze();"><input type="number" id="wpR" value="5" oninput="analyze();"><input type="number" id="wpS" value="3" oninput="analyze();"><input type="number" id="wpRPE" value="8" oninput="analyze();"></div>
            <label id="dipLabel">Weighted Dip</label>
            <div class="inline-quad"><input type="number" id="wdW" value="35" oninput="analyze();"><input type="number" id="wdR" value="5" oninput="analyze();"><input type="number" id="wdS" value="3" oninput="analyze();"><input type="number" id="wdRPE" value="8" oninput="analyze();"></div>
            <label id="zanLabel">Zanetti Raise (SA)</label>
            <div class="inline-quad"><input type="number" id="saW" value="12" oninput="analyze();"><input type="number" id="saR" value="8" oninput="analyze();"><input type="number" id="saS" value="3" oninput="analyze();"><input type="number" id="saRPE" value="9" oninput="analyze();"></div>
        </div>
    </div>

    <div class="dashboard-row" id="captureArea">
        <div class="analysis-panel" id="chart-card" style="min-height: 300px; position: relative; display: flex; align-items: center; justify-content: center;">
            <div id="radar-lock" class="prepare-overlay">
                <button class="btn-prepare" onclick="prepareSystem()">PREPARE TRAINING MATRIX</button>
            </div>
            <canvas id="skillRadar"></canvas>
        </div>

        <div class="analysis-panel" id="skillBars">
             <div style="text-align: center; color: #444; margin-top: 100px;">SYSTEM OFFLINE</div>
        </div>

        <div class="analysis-panel" id="auditWrapper">
            <div style="background:#1f1f2e; padding:15px; border-radius:12px; border: 1px solid #333;">
                <div id="aiFeedback">
                     <div style="text-align: center; color: #444; margin-top: 100px;">AWAITING AUDIT</div>
                </div>
            </div>
            <button id="shareBtn" onclick="shareReport()" style="display:none; width:100%; margin-top:15px; background:transparent; border:1px solid var(--potential); color:var(--potential); cursor:pointer; padding:12px; font-family: monospace; border-radius:8px; font-size:0.7em; text-transform:uppercase;">Download_Report.png</button>
        </div>
    </div>
    <button id="shareBtn" onclick="shareReport()" style="display:none; width:100%; margin-top:15px; background:transparent; border:1px solid var(--potential); color:var(--potential); cursor:pointer; padding:12px; font-family: monospace; border-radius:8px; font-size:0.7em; text-transform:uppercase;">Download_Report.png</button>
</div>
    <div style="text-align: center; color: #444; margin-top: 80px;">AWAITING AUDIT</div>
</div>
             <div style="text-align: center; color: #444; margin-top: 100px;">AWAITING AUDIT</div>
        </div>
    </div>

    <div class="heatmap-container">
        <h3 style="font-size:0.7em; color:var(--primary); margin-bottom:10px; letter-spacing: 1px;">INJURY RISK HEATMAP</h3>
        
        <svg width="120" height="180" viewBox="0 0 100 150">
            <circle cx="50" cy="20" r="10" class="joint" /> 
            <line x1="50" y1="30" x2="50" y2="80" stroke="#333" stroke-width="4" /> 
            <line x1="50" y1="40" x2="20" y2="60" stroke="#333" stroke-width="3" /> 
            <line x1="20" y1="60" x2="10" y2="90" stroke="#333" stroke-width="3" /> 
            <line x1="50" y1="40" x2="80" y2="60" stroke="#333" stroke-width="3" /> 
            <line x1="80" y1="60" x2="90" y2="90" stroke="#333" stroke-width="3" /> 
            <circle id="joint-shoulder-l" cx="35" cy="40" r="5" class="joint" /> 
            <circle id="joint-shoulder-r" cx="65" cy="40" r="5" class="joint" />
            <circle id="joint-elbow-l" cx="20" cy="60" r="5" class="joint" /> 
            <circle id="joint-elbow-r" cx="80" cy="60" r="5" class="joint" />
            <circle id="joint-wrist-l" cx="10" cy="90" r="4" class="joint" /> 
            <circle id="joint-wrist-r" cx="90" cy="90" r="4" class="joint" />
        </svg>
        <p id="risk-msg" style="font-size:0.65em; color:#888; margin-top:10px; font-weight: bold;">SCANNINING BIOMETRICS...</p>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3>Volume & Recovery Optimizer</h3>
        <div class="volume-grid">
            <div class="stat-box">
                <span class="stat-label">Weekly Volume Tax</span>
                <span id="volume-tax" class="stat-val">0</span>
                <div class="battery-bar"><div id="volume-fill" class="battery-fill"></div></div>
            </div>
            <div class="stat-box">
                <span class="stat-label">Recovery Window</span>
                <span id="recovery-status" class="stat-val">OPTIMAL</span>
            </div>
        </div>
        <p id="volume-advice" style="font-size: 0.65em; color: #888; margin-top: 10px; text-align: center;">Ready for high-intensity loading.</p>
    </div>

    <div class="card" style="margin-top: 25px; border-color: var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="border: none; margin: 0;">Training History Log</h3>
            <button class="btn-log" onclick="logSession()">LOG CURRENT DATA</button>
        </div>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>BW</th>
                        <th>Pull Max</th>
                        <th>Push Max</th>
                        <th>SA Max</th>
                        <th>Strongest Skill</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="logBody"></tbody>
            </table>
        </div>
    </div>

    <h2 style="color:var(--primary); margin-top:40px; letter-spacing:2px; font-size:1em; text-align:center;">SUPPORT THE GRIND</h2>
    <div style="text-align: center; padding: 30px; background: #1f1f2e; border-radius: 20px; border: 1px dashed var(--primary); width: 100%; max-width: 1300px; box-sizing: border-box; margin: 20px auto;">
        <p style="font-size: 0.8em; color: #888; margin-bottom: 20px;">I'm refining these tools every day through my own training. If this data helps your progress, consider fueling the research.</p>
        <a href="https://www.buymeacoffee.com/CaliBiotech" target="_blank" style="display: inline-flex; align-items: center; background: #FFDD00; color: #000000; padding: 12px 24px; border-radius: 10px; text-decoration: none; font-weight: bold; font-size: 0.9em; transition: 0.3s; box-shadow: 0 4px 15px rgba(255, 221, 0, 0.2);">
            <img src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="Buy me a coffee" style="height: 20px; margin-right: 10px;">
            Buy me a protein shake
        </a>
    </div>
<div class="card" style="margin-top: 40px; background: rgba(76, 111, 255, 0.05); border: 1px solid var(--primary);">
    <h3 style="border: none;">The Science of Cali-Biotech</h3>
    <p style="font-size: 0.75em; line-height: 1.6; color: #bbb;">
        Our command system uses <strong>Biomechanical Torque Analysis</strong> to bridge the gap between weighted strength and bodyweight mastery. Unlike standard calculators, we account for <strong>stature-based leverage</strong>. 
    </p>
    <ul style="font-size: 0.7em; color: #888; line-height: 1.8;">
        <li><strong>Torque Scaling:</strong> We apply a scaling factor of <strong>(Height / 170)<sup>2.3</sup></strong> to account for the increased moment arm in taller athletes.</li>
        
        <li><strong>Structural Integrity:</strong> The 1:1 Push/Pull ratio is monitored to prevent scapular protraction dominance and subacromial impingement.</li>
        <li><strong>Straight-Arm (SA) Integrity:</strong> We calculate the ratio between your bent-arm pressing power and your Straight-Arm capacity (Zanetti Load) to ensure your tendons can handle isometric transitions like the Iron Cross or Maltese.</li>
    </ul>
</div>
    <div class="blog-section">
        <h3 style="color:var(--primary); font-size:0.9em; margin-bottom: 15px;">RESOURCES & GUIDES</h3>
        <a href="blog/chest-guide.html" class="blog-link">3 Best Exercises for a Massive Chest</a>
        <a href="blog/planche-guide.html" class="blog-link">Unlock the Planche: Top 3 Exercises</a>
        <a href="blog/pullup-guide.html" class="blog-link">First Pull-up Guide</a>
         <a href="blog/back-thickness.html" class="blog-link">Back Thickness</a>
         <a href="blog/weighted-calisthenics.html" class="blog-link">Drop the Ego: Weighted Training</a>
         <a href="blog/hardest-skills.html" class="blog-link">10 Hardest Skills</a>
         <a href="blog/beginner-skills.html" class="blog-link">Beginner Skills</a>
         <a href="blog/fast-track-skills.html" class="blog-link">8-12 Week Skills</a>
         <a href="blog/equipment-guide.html" class="blog-link">Essential Equipment</a>
         <a href="blog/attractive-physique.html" class="blog-link">Top Aesthetic Bodyparts</a>
         <a href="blog/calisthenics-diet.html" class="blog-link">The Truth About Bulking</a>
        <a href="blog/privacy.html" class="blog-link">Privacy Policy</a>
        <a href="blog/about.html" class="blog-link">About Cali-Biotech</a>
        <a href="blog/contact.html" class="blog-link">Contact Us</a>
       <a href="blog/terms.html" class="blog-link">Terms</a>
        <p style="font-size: 0.6em; color: #444; margin-top: 25px;">Â© 2026 Cali-Biotech Command Systems.</p>
    </div>
</div>

<script>
let isSystemReady = false;
let isSimMode = false;

function toggleSimMode() {
    isSimMode = document.getElementById("simMode").checked;
    const container = document.getElementById("mainContainer");
    
    if (isSimMode) {
        container.classList.add('sim-active');
    } else {
        container.classList.remove('sim-active');
        loadSavedData(); 
    }
    analyze();
}

function prepareSystem() {
    isSystemReady = true;
    document.getElementById("radar-lock").style.display = "none";
    analyze();
}

function updateLabels() {
    const isMet = document.getElementById("unitSystem").value === 'met';
    document.getElementById("wLabel").innerText = isMet ? "Weight (kg)" : "Weight (lbs)";
    document.getElementById("hMetric").style.display = isMet ? "block" : "none";
    document.getElementById("hImperial").style.display = isMet ? "none" : "block";
}

const skills = [
    { name: "Full Planche", p: 3.4, l: 0, s: 2.5, minEntry: 45 },
    { name: "Straddle Planche", p: 2.8, l: 0, s: 2.0, minEntry: 30 },
    { name: "Front Lever", p: 0, l: 2.6, s: 1.8, minEntry: 30 },
    { name: "Iron Cross", p: 0, l: 3.0, s: 4.0, minEntry: 50 },
    { name: "Maltese", p: 4.5, l: 0, s: 3.5, minEntry: 55 },
    { name: "Muscle-up", p: 1.5, l: 1.6, s: 0, minEntry: 15 }
];

const recs = {
    "Full Planche": "Planche Leans / PPPU",
    "Straddle Planche": "Tuck Planche Holds",
    "Front Lever": "Scapular Pulls / Negatives",
    "Iron Cross": "Rings Fly / Cross Pulls",
    "Maltese": "Zanetti Press / Ring Fly",
    "Muscle-up": "High Pull-ups / Explosive Row"
};

let radarChart;
const ctx = document.getElementById('skillRadar').getContext('2d');

function initChart() {
    radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: skills.map(s => s.name),
            datasets: [
                { label: 'Reality', data: [], backgroundColor: 'rgba(76, 111, 255, 0.2)', borderColor: '#4c6fff', borderWidth: 2 },
                { label: 'Potential', data: [], backgroundColor: 'rgba(0, 255, 204, 0.05)', borderColor: '#00ffcc', borderDash: [5, 5] }
            ]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: { r: { beginAtZero: true, max: 100, ticks: { display: false }, grid: { color: '#2a2a3a' } } }, 
            plugins: { legend: { display: false } } 
        }
    });
}

function saveToLocal() {
    if (isSimMode) return; 
    const inputs = document.querySelectorAll('input, select');
    const data = {};
    inputs.forEach(input => { data[input.id] = input.value; });
    localStorage.setItem('caliData', JSON.stringify(data));
}

function loadSavedData() {
    const saved = localStorage.getItem('caliData');
    if (saved) {
        const data = JSON.parse(saved);
        Object.keys(data).forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = data[id]; });
        updateLabels();
    }
}

function logSession() {
    const savedLogs = localStorage.getItem('caliLogs') ? JSON.parse(localStorage.getItem('caliLogs')) : [];
    const sys = document.getElementById("unitSystem").value;
    const u = sys === 'met' ? 'kg' : 'lbs';
    
    const get1RM = (idW, idR) => {
        let w = parseFloat(document.getElementById(idW).value) || 0;
        let r = parseInt(document.getElementById(idR).value) || 0;
        let bw = parseFloat(document.getElementById("weight").value) || 0;
        return (bw + w * (1 + r/30)).toFixed(1);
    };

    let topSkill = "None";
    let maxVal = -1;
    document.querySelectorAll('.skill-label').forEach(el => {
        let valText = el.children[1].innerText;
        let val = parseInt(valText);
        if(!isNaN(val) && val > maxVal) { maxVal = val; topSkill = el.children[0].innerText.replace("âš¡ ", "").replace("ðŸ”’ ", ""); }
    });

    const entry = {
        date: new Date().toLocaleDateString(),
        bw: document.getElementById("weight").value + u,
        pull: get1RM("wpW", "wpR") + u,
        push: get1RM("wdW", "wdR") + u,
        sa: get1RM("saW", "saR") + u,
        skill: topSkill + " (" + (maxVal > 0 ? maxVal : 0) + "%)"
    };

    savedLogs.unshift(entry);
    localStorage.setItem('caliLogs', JSON.stringify(savedLogs.slice(0, 8)));
    renderLogs();
}

function renderLogs() {
    const savedLogs = localStorage.getItem('caliLogs') ? JSON.parse(localStorage.getItem('caliLogs')) : [];
    const container = document.getElementById("logBody");
    container.innerHTML = savedLogs.map((l, i) => `
        ctr>
            <td>${l.date}</td>
            <td>${l.bw}</td>
            <td>${l.pull}</td>
            <td>${l.push}</td>
            <td>${l.sa}</td>
            <td style="color:var(--potential)">${l.skill}</td>
            <td><button onclick="deleteLog(${i})" style="background:none; border:none; color:var(--danger); cursor:pointer;">âœ•</button></td>
        </tr>
    `).join('');
}

function deleteLog(i) {
    const savedLogs = JSON.parse(localStorage.getItem('caliLogs'));
    savedLogs.splice(i, 1);
    localStorage.setItem('caliLogs', JSON.stringify(savedLogs));
    renderLogs();
}

function generateGoalBrief(vectors, bw, conv, u) {
    let bottlenecks = [...vectors].sort((a, b) => a.val - b.val).slice(0, 2);
    let brief = `<div style="margin-top: 8px; font-size: 0.6em; color: var(--potential); font-weight: bold; text-transform: uppercase;">Mission Requirements:</div>`;
    
    bottlenecks.forEach(b => {
        let targetTotalWeight = b.req * bw;
        let currentTotalWeight = b.raw * bw;
        
        // Use 'gap' consistently
        let gap = (targetTotalWeight - currentTotalWeight) / conv;
        
        let exerciseName = "";
        let equipment = "to belt/bar";

        if (b.name === "Push") exerciseName = "Weighted Dip";
        if (b.name === "Pull") exerciseName = "Weighted Pull-up";
        if (b.name === "SA Strength") {
            exerciseName = "Zanetti Raise";
            gap = gap / 2; 
            equipment = "per dumbbell";
        }

        // CHANGED: Use 'gap' here instead of 'displayGap'
        brief += `<span class="rec-exercise" style="opacity:1">â†‘ **${exerciseName}**: Add +${Math.max(0, gap).toFixed(1)}${u} ${equipment}</span>`;
    });
    return brief;
}
function analyze() {
    if(!isSystemReady) return; 
    if(!radarChart) initChart();

    try {
        const sys = document.getElementById("unitSystem").value;
        const conv = sys === 'imp' ? 0.453592 : 1;
        const u = sys === 'met' ? 'kg' : 'lbs';
        
        let bw = (parseFloat(document.getElementById("weight").value) || 75) * conv;
        let h = sys === 'met' ? (parseFloat(document.getElementById("hCm").value) || 170) : ((parseFloat(document.getElementById("hFt").value)||5)*30.48)+((parseFloat(document.getElementById("hIn").value)||7)*2.54);

        // 1. CALCULATIONS
        const pull1RM = (bw + (parseFloat(document.getElementById("wpW").value)||0)*conv * (1 + (parseInt(document.getElementById("wpR").value)||0)/30)) / bw;
        const push1RM = (bw + (parseFloat(document.getElementById("wdW").value)||0)*conv * (1 + (parseInt(document.getElementById("wdR").value)||0)/30)) / bw;
        let rawSa = (bw + (parseFloat(document.getElementById("saW").value)||0)*conv * (1 + (parseInt(document.getElementById("saR").value)||0)/30)) / bw;
        const sa1RM = Math.max(rawSa, (push1RM * 0.75)); 

        const torqueFactor = Math.pow(h / 170, 2.3) * (parseFloat(document.getElementById("legRatio").value) || 1.0);
        const cnsVal = (parseInt(document.getElementById("cns").value) || 10) / 10;
        const form = parseFloat(document.getElementById("form").value) || 1.0;

        // 2. SIM MODE / OPTIMIZER
        if (isSimMode) {
            radarChart.data.datasets[0].label = 'SIMULATED TARGET';
            radarChart.data.datasets[0].borderColor = '#00ffcc';
        } else {
            radarChart.data.datasets[0].label = 'REALITY';
            radarChart.data.datasets[0].borderColor = '#4c6fff';
            if (typeof saveToLocal === 'function') saveToLocal(); 
        }

        // 3. SKILL BARS & PROGRESS
        let skillPanel = document.getElementById("skillBars");
        if (!document.getElementById("goalSelect")) {
            skillPanel.innerHTML = `<div style="margin-bottom:20px;"><label style="color:var(--primary); font-size:0.7em; letter-spacing:2px;">MISSION_TARGET</label>
            <select id="goalSelect" onchange="analyze()" style="background:#111; color:#fff; width:100%; border:1px solid #333; padding:10px; border-radius:5px; margin-top:5px;">
                <option value="None">No Active Goal</option>${skills.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
            </select></div><div id="barContainer"></div>`;
        }

        const activeGoal = document.getElementById("goalSelect").value;
        let barHtml = ""; const curScores = []; const potScores = [];

        skills.forEach(s => {
            let vectors = [];
            if (s.p > 0) vectors.push({ name: "Push (Dips)", val: (push1RM / (s.p * torqueFactor)) * 100, req: s.p * torqueFactor });
            if (s.l > 0) vectors.push({ name: "Pull (Pullups)", val: (pull1RM / (s.l * torqueFactor)) * 100, req: s.l * torqueFactor });
            if (s.s > 0) vectors.push({ name: "SA (Zanetti)", val: (sa1RM / (s.s * torqueFactor)) * 100, req: s.s * torqueFactor });
            
            const sig = (x) => 100 / (1 + Math.exp(-0.15 * (x - 52)));
            let minVal = Math.min(...vectors.map(v => v.val));
            let cur = sig(minVal) * cnsVal * form;
            
            const isTarget = s.name === activeGoal;
            curScores.push(cur.toFixed(1));
            potScores.push(sig(Math.max(...vectors.map(v => v.val))).toFixed(1));

            let recText = "";
            if (isTarget) {
                let weakest = vectors.reduce((prev, curr) => (prev.val < curr.val) ? prev : curr);
                let neededPlate = ((weakest.req * bw) - bw) / conv;
                recText = `CRITICAL PATH: Improve ${weakest.name}. Target 1RM: +${neededPlate.toFixed(1)}${u}.`;
            }

            barHtml += `
                <div class="skill-bar-container" style="opacity: ${activeGoal !== "None" && !isTarget ? '0.2' : '1'}; margin-bottom:15px;">
                    <div class="skill-label" style="display:flex; justify-content:space-between; font-family:monospace; font-size:0.85em;">
                        <span>${s.name.toUpperCase()}</span><span>${cur.toFixed(0)}%</span>
                    </div>
                    <div class="bar-bg" style="background:#111; height:6px; border-radius:10px; border:1px solid #333;">
                        <div class="bar-fill" style="width: ${cur}%; height:100%; background: ${isTarget ? 'var(--potential)' : 'var(--primary)'}; border-radius:10px;"></div>
                    </div>
                    ${isTarget ? `<div style="font-size:0.7em; color:var(--potential); margin-top:5px; font-family:monospace;">> ${recText}</div>` : ''}
                </div>`;
        });

        // 4. DEEP DIAGNOSTIC AUDIT LOGIC
        const pullPushRatio = (pull1RM / push1RM).toFixed(2);
        const saIntegrity = (sa1RM / push1RM).toFixed(2);
        const relPower = push1RM.toFixed(2);

        let tStatus = torqueFactor > 1.08 ? "PENALTY" : "OPTIMAL";
        let tDesc = torqueFactor > 1.08 ? `Height (${h.toFixed(0)}cm) creates lever disadvantage.` : `Optimal leverages for statics.`;
        let bStatus = pullPushRatio < 0.85 ? "DEFICIT" : "BALANCED";
        let bDesc = pullPushRatio < 0.85 ? `Pull chain is ${((1-pullPushRatio)*100).toFixed(0)}% behind Push.` : `Scapular stabilizers are matched.`;
        let sStatus = saIntegrity < 0.62 ? "TENDON LAG" : "NOMINAL";
        let sDesc = saIntegrity < 0.62 ? `Muscle power outpaces connective tissue.` : `Density sufficient for SA loads.`;

        let auditHtml = `<h3 style="font-size:0.7em; letter-spacing:3px; color:var(--primary); margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">BIOMECHANICAL_REPORT</h3>`;
        
        const createInsight = (title, status, val, desc, color) => `
            <div class="insight-block" style="margin-bottom:15px; border-left:3px solid ${color}; padding-left:12px; background: rgba(255,255,255,0.02); padding-top:8px; padding-bottom:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.8em; font-weight:bold; color:${color};">${title}</span>
                    <span style="font-size:0.6em; background:${color}; color:#000; padding:1px 4px; border-radius:2px; font-weight:bold;">${status}</span>
                </div>
                <div style="font-size:1em; color:#fff; font-family:monospace; margin:4px 0;">${val}</div>
                <p style="font-size:0.65em; color:#bbb; margin:0; line-height:1.4;">${desc}</p>
            </div>`;

        auditHtml += createInsight("TORQUE_LOAD", tStatus, torqueFactor.toFixed(2) + "x", tDesc, torqueFactor > 1.08 ? "#ff9900" : "#888");
        auditHtml += createInsight("POSTERIOR_CHAIN", bStatus, pullPushRatio, bDesc, pullPushRatio < 0.85 ? "#ff4444" : "#00ffcc");
        auditHtml += createInsight("CONNECTIVE_TISSUE", sStatus, saIntegrity, sDesc, saIntegrity < 0.62 ? "#ff4444" : "#00ffcc");
        auditHtml += createInsight("RELATIVE_POWER", "FORCE", relPower + "x BW", "Force generation relative to mass.", "var(--primary)");

        // 5. GENETIC CEILING & PROGRESSION TIER AUTO-INJECTION
        let ceilingDiv = document.getElementById("geneticCeiling");
        if (!ceilingDiv) {
            ceilingDiv = document.createElement("div");
            ceilingDiv.id = "geneticCeiling";
            document.getElementById("aiFeedback").parentNode.appendChild(ceilingDiv);
        }

        const bmi = (bw / (Math.pow(h/100, 2))).toFixed(1);
        const idealWeightMin = (21 * Math.pow(h/100, 2)) / conv;
        const idealWeightMax = (23.5 * Math.pow(h/100, 2)) / conv;
        const strengthTax = ((torqueFactor - 1) * 100).toFixed(1);

        let cMsg = ""; let cCol = "#00ffcc";
        if (bmi > 26) { cMsg = "HEAVYWEIGHT PENALTY: High mass increases torque demands."; cCol = "#ff9900"; }
        else if (bmi < 19) { cMsg = "POWER_DEFICIT: Low muscle volume for frame."; cCol = "#00ccff"; }
        else { cMsg = "OPTIMAL FRAME: BMI is in the elite power-to-weight window."; }

        ceilingDiv.innerHTML = `
            <h3 style="font-size:0.7em; letter-spacing:3px; color:var(--primary); margin-top:25px; border-bottom:1px solid #333; padding-bottom:10px;">GENETIC_CEILING</h3>
            <div class="insight-block" style="margin-bottom:15px; border-left:3px solid ${cCol}; padding-left:12px; background: rgba(255,255,255,0.02); padding:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.8em; font-weight:bold; color:${cCol};">FRAME_EFFICIENCY</span>
                    <span style="font-size:0.7em; color:#fff;">BMI: ${bmi}</span>
                </div>
                <p style="font-size:0.65em; color:#bbb; margin:8px 0; line-height:1.4;">${cMsg}</p>
                <div style="font-size:0.65em; color:#888;">Ideal Weight for ${h.toFixed(0)}cm: <span style="color:#fff;">${idealWeightMin.toFixed(0)}-${idealWeightMax.toFixed(0)}${u}</span></div>
            </div>
            <div class="insight-block" style="border-left:3px solid #ff4444; padding-left:12px; background: rgba(255,255,255,0.02); padding:10px;">
                <span style="font-size:0.8em; font-weight:bold; color:#ff4444;">LEVERAGE_TAX: +${strengthTax}%</span>
                <p style="font-size:0.65em; color:#bbb; margin:5px 0; line-height:1.4;">Based on height, you require ${strengthTax}% more raw force than a 170cm reference athlete.</p>
            </div>`;

        // PROGRESSION TIER LOGIC
        let tierDiv = document.getElementById("progressionTier");
        if (!tierDiv) {
            tierDiv = document.createElement("div");
            tierDiv.id = "progressionTier";
            ceilingDiv.parentNode.appendChild(tierDiv);
        }

        let tierHtml = "";
        if (activeGoal !== "None") {
            const skillIdx = skills.findIndex(sk => sk.name === activeGoal);
            const score = parseFloat(curScores[skillIdx]);
            let tier = "NOVICE"; let milestone = "Tuck Progression"; let tCol = "#888";

            if (score > 90) { tier = "MASTER (Weighted)"; milestone = "Added Load Statics"; tCol = "#ff00ff"; }
            else if (score > 70) { tier = "ELITE (Full)"; milestone = "Full Static Mastery"; tCol = "#00ffcc"; }
            else if (score > 45) { tier = "ADVANCED (Straddle)"; milestone = "Half-Lay / One Leg Out"; tCol = "#ffcc00"; }
            else if (score > 20) { tier = "INTERMEDIATE (Tuck)"; milestone = "Advanced Tuck / Open Tuck"; tCol = "#00ccff"; }

            tierHtml = `
                <h3 style="font-size:0.7em; letter-spacing:3px; color:var(--primary); margin-top:25px; border-bottom:1px solid #333; padding-bottom:10px;">PROGRESSION_TIER</h3>
                <div class="insight-block" style="border-left:3px solid ${tCol}; padding:12px; background: rgba(255,255,255,0.03);">
                    <div style="font-size:0.65em; color:var(--primary); letter-spacing:1px; margin-bottom:5px;">CURRENT_BRACKET</div>
                    <div style="font-size:1.1em; font-weight:bold; color:${tCol}; font-family:monospace;">${tier}</div>
                    <div style="margin:10px 0; height:4px; background:#111; border-radius:2px; overflow:hidden;">
                        <div style="width:${score}%; height:100%; background:${tCol}; box-shadow: 0 0 10px ${tCol}55;"></div>
                    </div>
                    <div style="font-size:0.65em; color:#bbb;">NEXT_OBJECTIVE: <span style="color:#fff;">${milestone}</span></div>
                </div>`;
        }
        tierDiv.innerHTML = tierHtml;

        // 6. HEATMAP & VOLUME UPDATES
        const shoulders = document.querySelectorAll('#joint-shoulder-l, #joint-shoulder-r');
        const elbows = document.querySelectorAll('#joint-elbow-l, #joint-elbow-r');
        let riskMsg = "SYSTEMS_NOMINAL";

        if (pullPushRatio < 0.85) { shoulders.forEach(s => s.style.fill = "#ff4444"); riskMsg = "SHOULDER_RISK"; }
        else { shoulders.forEach(s => s.style.fill = "#00ffcc"); }
        if (saIntegrity < 0.60) { elbows.forEach(e => e.style.fill = "#ff4444"); riskMsg = "ELBOW_RISK"; }
        else { elbows.forEach(e => e.style.fill = "#00ffcc"); }

        const rMsg = document.getElementById("risk-msg");
        if (rMsg) { rMsg.innerText = riskMsg; rMsg.style.color = (riskMsg === "SYSTEMS_NOMINAL") ? "#00ffcc" : "#ff4444"; }

        let totalTax = ((parseInt(document.getElementById("wpS").value)||0) * 1.5) + ((parseInt(document.getElementById("wdS").value)||0) * 1.5);
        const vFill = document.getElementById("volume-fill");
        if (vFill) vFill.style.width = Math.min((totalTax / 20) * 100, 100) + "%";
        const vTax = document.getElementById("volume-tax");
        if (vTax) vTax.innerText = totalTax.toFixed(1);

        // 7. FINAL INJECTION
        document.getElementById("aiFeedback").innerHTML = auditHtml;
        document.getElementById("barContainer").innerHTML = barHtml;
        radarChart.data.datasets[0].data = curScores;
        radarChart.data.datasets[1].data = potScores;
        radarChart.update();

    } catch (err) { console.error(err); }
}
// Function 1: The actual image saver
function shareReport() {
    const target = document.getElementById("captureArea");
    const btn = document.getElementById("shareBtn");
    btn.innerText = "GENERATING...";
    
    html2canvas(target, { 
        backgroundColor: "#1f1f2e",
        scale: 2 // Makes the image high quality
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'CaliBiotech_Report.png';
        link.href = canvas.toDataURL();
        link.click();
        btn.innerText = "DOWNLOAD_REPORT.PNG";
    });
}
function shareReport() {
    const target = document.getElementById("captureArea");
    const btn = document.getElementById("shareBtn");
    btn.innerText = "GENERATING...";
    
    html2canvas(target, { 
        backgroundColor: "#1f1f2e",
        scale: 2 
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'CaliBiotech_Report.png';
        link.href = canvas.toDataURL();
        link.click();
        btn.innerText = "DOWNLOAD_REPORT.PNG";
    });
}
document.getElementById("shareBtn").style.display = "block";
</script>
</body>
</html>